function [J, dJdZ] = TestDynamicsConstraints()

persistent lagInt
    
if ~exist(lagInt)
    lagInt = LagrangeInterpolator;
end

%%  Define ephemeris data
data =[21545.00000039794       7100                        0                           1300                        0                            7.35                         1                            
21545.00069484238       7086.478452769565           440.720219715447            1357.486158401703           -0.4502404695480039          7.336023141510919            0.915659990767392            
21545.00179115092       7010.456306549843           1132.424129592319           1437.675985995769           -1.15286972008434            7.257653465889803            0.7763470237120195           
21545.00294870525       6858.730656733248           1851.102502780823           1507.674603714286           -1.877769134421329           7.101759683158154            0.6224089234651163           
21545.00411709389       6633.252415951107           2556.969864146001           1562.426231098006           -2.584682945609766           6.870844156345942            0.4615569218119166           
21545.00529037994       6336.57729617995            3238.712906406058           1600.85958992972            -3.262635014129067           6.567940376256425            0.2962134542764657           
21545.00646772669       5971.703246243432           3888.4816731297             1622.455579133407           -3.904290196953737           6.196429661143253            0.1281816185153614           
21545.00764880704       5542.331086182737           4499.065323160338           1626.910746822161           -4.503056326106363           5.760293807522976            -0.04078982777681679         
21545.00883333023       5052.887076258268           5063.679435045634           1614.112484477757           -5.052839581178576           5.264127165870185            -0.2089600329689183          
21545.01002096521       4508.500028748062           5576.00355180579            1584.139944284926           -5.548051132944092           4.713107916516709            -0.3746011759703399          
21545.01121135004       3914.947338405964           6030.264314746278           1537.265468107072           -5.983658227116587           4.112944039738321            -0.5360151706037545          
21545.01157447201       3725.316736284499           6156.306012846086           1519.692902297702           -6.103821841559192           3.92127862664444             -0.5840938861152164          
];

%% Initialize the interpolator
tVec   = (data(:,1) - data(1,1))*86400; 
X      = data(:,2:7);
lagInt = LagrangeInterpolator;
lagInt.setIndependentVariables(tVec);
D      = lagInt.GetDiffMatrix;

%% Step through the discretization and construct the constraint vector
J = zeros(lagInt.numPoints*6,1);
ctr = 1;
for rowIdx = 1:lagInt.numPoints
   J(ctr:ctr+5,1) = (D(rowIdx,:)*X)' - OrbitDot(tVec(rowIdx,1)...
                     *86400,X(rowIdx,1:6)',0);
   ctr = ctr + 6;
end

%%  Simple dynamics function
function [xdot,A] = OrbitDot(~,x,u)

mu = 398600.4415;
rv = x(1:3,1);
vv = x(4:6,1);
r  = norm(rv);

xdot(1:3,1) = vv;
xdot(4:6,1) = -mu/r^3*rv;






